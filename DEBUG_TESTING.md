# BPF Optimizer æµ‹è¯•è°ƒè¯•æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•è°ƒè¯• BPF Optimizer é¡¹ç›®ä¸­çš„å•å…ƒæµ‹è¯•ã€‚æ”¯æŒå¤šç§è°ƒè¯•æ–¹å¼ï¼šVS Code å›¾å½¢åŒ–è°ƒè¯•ã€å‘½ä»¤è¡Œè°ƒè¯•ã€ä»¥åŠå„ç§æµ‹è¯•ç±»å‹çš„è°ƒè¯•ã€‚

## ğŸ› ï¸ è°ƒè¯•ç¯å¢ƒé…ç½®

### å·²é…ç½®çš„ç»„ä»¶

1. **VS Code è°ƒè¯•é…ç½®** - `.vscode/launch.json`
2. **Makefile è°ƒè¯•ç›®æ ‡** - å¤šç§æµ‹è¯•è°ƒè¯•å‘½ä»¤
3. **è°ƒè¯•è¾…åŠ©è„šæœ¬** - `scripts/debug-helper.sh`
4. **Delve è°ƒè¯•å™¨** - Go å®˜æ–¹è°ƒè¯•å·¥å…·

### ç¯å¢ƒæ£€æŸ¥

```bash
# æ£€æŸ¥è°ƒè¯•ç¯å¢ƒ
./scripts/debug-helper.sh check
```

## ğŸ§ª VS Code è°ƒè¯•æµ‹è¯•

### å¯ç”¨çš„è°ƒè¯•é…ç½®

1. **Debug Current Test File** - è°ƒè¯•å½“å‰æ–‡ä»¶çš„æ‰€æœ‰æµ‹è¯•
2. **Debug Specific Test** - è°ƒè¯•æŒ‡å®šçš„æµ‹è¯•å‡½æ•°
3. **Debug All Tests** - è°ƒè¯•æ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰æµ‹è¯•
4. **Debug BPF Package Tests** - è°ƒè¯• BPF åŒ…æµ‹è¯•
5. **Debug Optimizer Package Tests** - è°ƒè¯•ä¼˜åŒ–å™¨åŒ…æµ‹è¯•
6. **Debug Test with Coverage** - å¸¦è¦†ç›–ç‡çš„æµ‹è¯•è°ƒè¯•
7. **Debug Benchmark Tests** - è°ƒè¯•åŸºå‡†æµ‹è¯•
8. **Debug Test with Race Detection** - å¸¦ç«æ€æ£€æµ‹çš„æµ‹è¯•è°ƒè¯•

### ä½¿ç”¨æ–¹æ³•

1. åœ¨ VS Code ä¸­æ‰“å¼€é¡¹ç›®
2. æ‰“å¼€è¦è°ƒè¯•çš„æµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚ `pkg/bpf/instruction_test.go`ï¼‰
3. åœ¨æµ‹è¯•å‡½æ•°ä¸­è®¾ç½®æ–­ç‚¹
4. æŒ‰ `F5` æˆ–ç‚¹å‡»è°ƒè¯•æŒ‰é’®
5. é€‰æ‹©é€‚å½“çš„è°ƒè¯•é…ç½®
6. è¾“å…¥æµ‹è¯•å‡½æ•°åï¼ˆå¦‚æœéœ€è¦ï¼‰

### ç¤ºä¾‹ï¼šè°ƒè¯•æŒ‡å®šæµ‹è¯•

1. æ‰“å¼€ `pkg/bpf/instruction_test.go`
2. åœ¨ `TestNewInstruction` å‡½æ•°ä¸­è®¾ç½®æ–­ç‚¹
3. æŒ‰ `F5`ï¼Œé€‰æ‹© "Debug Specific Test"
4. è¾“å…¥æµ‹è¯•åï¼š`TestNewInstruction`
5. å¼€å§‹è°ƒè¯•

## ğŸ”§ å‘½ä»¤è¡Œè°ƒè¯•æµ‹è¯•

### ä½¿ç”¨è°ƒè¯•è¾…åŠ©è„šæœ¬

#### åŸºæœ¬æµ‹è¯•è°ƒè¯•

```bash
# è°ƒè¯• BPF åŒ…çš„æ‰€æœ‰æµ‹è¯•
./scripts/debug-helper.sh test

# è°ƒè¯•æŒ‡å®šåŒ…çš„æµ‹è¯•
./scripts/debug-helper.sh test ./pkg/optimizer
```

#### è°ƒè¯•æŒ‡å®šæµ‹è¯•å‡½æ•°

```bash
# è°ƒè¯•æŒ‡å®šæµ‹è¯•å‡½æ•°
./scripts/debug-helper.sh test-specific TestNewInstruction

# è°ƒè¯•æŒ‡å®šåŒ…ä¸­çš„æµ‹è¯•å‡½æ•°
./scripts/debug-helper.sh test-specific TestParse ./pkg/bpf
```

#### è°ƒè¯•æ‰€æœ‰æµ‹è¯•

```bash
# è°ƒè¯•é¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•
./scripts/debug-helper.sh test-all
```

#### è°ƒè¯•åŸºå‡†æµ‹è¯•

```bash
# è°ƒè¯•æ‰€æœ‰åŸºå‡†æµ‹è¯•
./scripts/debug-helper.sh benchmark

# è°ƒè¯•æŒ‡å®šçš„åŸºå‡†æµ‹è¯•
./scripts/debug-helper.sh benchmark BenchmarkParse

# è°ƒè¯•æŒ‡å®šåŒ…çš„åŸºå‡†æµ‹è¯•
./scripts/debug-helper.sh benchmark . ./pkg/bpf
```

#### è°ƒè¯•æµ‹è¯•è¦†ç›–ç‡

```bash
# è°ƒè¯•å¸¦è¦†ç›–ç‡çš„æµ‹è¯•
./scripts/debug-helper.sh test-coverage

# è°ƒè¯•æŒ‡å®šåŒ…çš„æµ‹è¯•è¦†ç›–ç‡
./scripts/debug-helper.sh test-coverage ./pkg/optimizer
```

### ä½¿ç”¨ Makefile

```bash
# è°ƒè¯• BPF åŒ…æµ‹è¯•
make debug-test

# è°ƒè¯•æŒ‡å®šæµ‹è¯•ï¼ˆäº¤äº’å¼è¾“å…¥ï¼‰
make debug-test-specific

# è°ƒè¯•æ‰€æœ‰æµ‹è¯•
make debug-test-all

# è°ƒè¯•åŸºå‡†æµ‹è¯•ï¼ˆäº¤äº’å¼è¾“å…¥ï¼‰
make debug-benchmark

# è°ƒè¯•æµ‹è¯•è¦†ç›–ç‡ï¼ˆäº¤äº’å¼è¾“å…¥ï¼‰
make debug-test-coverage
```

## ğŸ› è°ƒè¯•å™¨å‘½ä»¤

### åŸºæœ¬å‘½ä»¤

```bash
# è®¾ç½®æ–­ç‚¹
b <function_name>          # åœ¨å‡½æ•°è®¾ç½®æ–­ç‚¹
b <file>:<line>           # åœ¨æ–‡ä»¶çš„æŒ‡å®šè¡Œè®¾ç½®æ–­ç‚¹
b TestNewInstruction      # åœ¨æµ‹è¯•å‡½æ•°è®¾ç½®æ–­ç‚¹

# æ‰§è¡Œæ§åˆ¶
c                         # ç»§ç»­æ‰§è¡Œ
n                         # ä¸‹ä¸€è¡Œï¼ˆä¸è¿›å…¥å‡½æ•°ï¼‰
s                         # æ­¥å…¥å‡½æ•°
finish                    # æ‰§è¡Œå®Œå½“å‰å‡½æ•°

# æŸ¥çœ‹å˜é‡
p <variable>              # æ‰“å°å˜é‡å€¼
locals                    # æ˜¾ç¤ºæ‰€æœ‰æœ¬åœ°å˜é‡
args                      # æ˜¾ç¤ºå‡½æ•°å‚æ•°
vars                      # æ˜¾ç¤ºåŒ…çº§å˜é‡

# è°ƒç”¨æ ˆ
bt                        # æ˜¾ç¤ºè°ƒç”¨æ ˆ
up                        # å‘ä¸Šç§»åŠ¨æ ˆå¸§
down                      # å‘ä¸‹ç§»åŠ¨æ ˆå¸§

# å…¶ä»–
l                         # åˆ—å‡ºå½“å‰ä»£ç 
help                      # æ˜¾ç¤ºå¸®åŠ©
q                         # é€€å‡ºè°ƒè¯•å™¨
```

### æµ‹è¯•ç‰¹å®šå‘½ä»¤

```bash
# æŸ¥çœ‹æµ‹è¯•ç»“æœ
p t.Failed()              # æ£€æŸ¥æµ‹è¯•æ˜¯å¦å¤±è´¥
p t.Name()                # è·å–æµ‹è¯•åç§°

# æŸ¥çœ‹æµ‹è¯•æ•°æ®
p testCases               # æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹æ•°æ®
p got                     # æŸ¥çœ‹å®é™…ç»“æœ
p want                    # æŸ¥çœ‹æœŸæœ›ç»“æœ
```

## ğŸ“ è°ƒè¯•ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè°ƒè¯•å¤±è´¥çš„æµ‹è¯•

```bash
# 1. å¯åŠ¨æŒ‡å®šæµ‹è¯•çš„è°ƒè¯•
./scripts/debug-helper.sh test-specific TestNewInstruction

# 2. åœ¨è°ƒè¯•å™¨ä¸­è®¾ç½®æ–­ç‚¹
(dlv) b TestNewInstruction

# 3. ç»§ç»­æ‰§è¡Œåˆ°æ–­ç‚¹
(dlv) c

# 4. æŸ¥çœ‹æµ‹è¯•æ•°æ®
(dlv) p testCases
(dlv) locals

# 5. æ­¥è¿›æ‰§è¡Œ
(dlv) n
(dlv) n

# 6. æŸ¥çœ‹å˜é‡å€¼
(dlv) p result
(dlv) p expected
```

### ç¤ºä¾‹2ï¼šè°ƒè¯•åŸºå‡†æµ‹è¯•

```bash
# 1. å¯åŠ¨åŸºå‡†æµ‹è¯•è°ƒè¯•
./scripts/debug-helper.sh benchmark BenchmarkParse

# 2. åœ¨åŸºå‡†æµ‹è¯•å‡½æ•°è®¾ç½®æ–­ç‚¹
(dlv) b BenchmarkParse

# 3. æŸ¥çœ‹åŸºå‡†æµ‹è¯•æ‰§è¡Œ
(dlv) c
(dlv) p b.N
(dlv) locals
```

### ç¤ºä¾‹3ï¼šè°ƒè¯•ç«æ€æ¡ä»¶

```bash
# ä½¿ç”¨ VS Code "Debug Test with Race Detection" é…ç½®
# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ
go test -race -v ./pkg/bpf
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è°ƒè¯•å™¨æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥ Delve æ˜¯å¦æ­£ç¡®å®‰è£…
   dlv version
   
   # é‡æ–°å®‰è£… Delve
   go install github.com/go-delve/delve/cmd/dlv@latest
   ```

2. **æ— æ³•è®¾ç½®æ–­ç‚¹**
   ```bash
   # ç¡®ä¿ä½¿ç”¨è°ƒè¯•æ„å»º
   go build -gcflags="all=-N -l" -o debug-binary ./cmd/optimizer
   
   # æ£€æŸ¥å‡½æ•°åæ˜¯å¦æ­£ç¡®
   (dlv) funcs TestNew*
   ```

3. **å˜é‡æ— æ³•æŸ¥çœ‹**
   ```bash
   # å˜é‡å¯èƒ½è¢«ä¼˜åŒ–æ‰ï¼Œä½¿ç”¨è°ƒè¯•æ„å»º
   # æˆ–æŸ¥çœ‹æ˜¯å¦åœ¨æ­£ç¡®çš„ä½œç”¨åŸŸ
   (dlv) locals
   (dlv) args
   ```

4. **æµ‹è¯•è¶…æ—¶**
   ```bash
   # å¢åŠ æµ‹è¯•è¶…æ—¶æ—¶é—´
   go test -timeout=30s -v ./pkg/bpf
   ```

### æ€§èƒ½æ³¨æ„äº‹é¡¹

- è°ƒè¯•æ¨¡å¼ä¼šæ˜¾è‘—é™ä½æ‰§è¡Œé€Ÿåº¦
- åŸºå‡†æµ‹è¯•åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç»“æœä¸å‡†ç¡®
- å¤§é‡æµ‹è¯•çš„è°ƒè¯•å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´

## ğŸ“š æœ€ä½³å®è·µ

### è°ƒè¯•ç­–ç•¥

1. **é€æ­¥ç¼©å°èŒƒå›´**
   - å…ˆè¿è¡Œæ‰€æœ‰æµ‹è¯•ç¡®å®šå¤±è´¥çš„æµ‹è¯•
   - ç„¶ååªè°ƒè¯•å¤±è´¥çš„æµ‹è¯•

2. **ä½¿ç”¨åˆé€‚çš„è°ƒè¯•é…ç½®**
   - å•ä¸ªæµ‹è¯•ï¼šä½¿ç”¨ "Debug Specific Test"
   - åŒ…æµ‹è¯•ï¼šä½¿ç”¨ "Debug BPF Package Tests"
   - æ€§èƒ½é—®é¢˜ï¼šä½¿ç”¨ "Debug Benchmark Tests"

3. **è®¾ç½®æœ‰æ•ˆæ–­ç‚¹**
   - åœ¨æµ‹è¯•å‡½æ•°å…¥å£è®¾ç½®æ–­ç‚¹
   - åœ¨å…³é”®é€»è¾‘å¤„è®¾ç½®æ–­ç‚¹
   - åœ¨æ–­è¨€å‰è®¾ç½®æ–­ç‚¹

4. **å……åˆ†åˆ©ç”¨å˜é‡æŸ¥çœ‹**
   - æŸ¥çœ‹æµ‹è¯•è¾“å…¥æ•°æ®
   - æŸ¥çœ‹ä¸­é—´å¤„ç†ç»“æœ
   - æŸ¥çœ‹æœŸæœ›vså®é™…ç»“æœ

### æµ‹è¯•ç¼–å†™å»ºè®®

```go
func TestExample(t *testing.T) {
    testCases := []struct {
        name     string
        input    string
        expected string
    }{
        {"case1", "input1", "output1"},
        {"case2", "input2", "output2"},
    }
    
    for _, tc := range testCases {
        t.Run(tc.name, func(t *testing.T) {
            // åœ¨è¿™é‡Œè®¾ç½®æ–­ç‚¹ä¾¿äºè°ƒè¯•
            result := YourFunction(tc.input)
            
            if result != tc.expected {
                t.Errorf("got %v, want %v", result, tc.expected)
            }
        })
    }
}
```

## ğŸ¯ æ€»ç»“

ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨å¤šç§æ–¹å¼è°ƒè¯•æµ‹è¯•ï¼š

- âœ… **VS Code å›¾å½¢åŒ–è°ƒè¯•** - æœ€ç›´è§‚çš„è°ƒè¯•æ–¹å¼
- âœ… **å‘½ä»¤è¡Œè°ƒè¯•** - çµæ´»çš„è°ƒè¯•é€‰é¡¹
- âœ… **å¤šç§æµ‹è¯•ç±»å‹** - å•å…ƒæµ‹è¯•ã€åŸºå‡†æµ‹è¯•ã€è¦†ç›–ç‡æµ‹è¯•
- âœ… **ä¾¿æ·è„šæœ¬** - ä¸€é”®å¯åŠ¨å„ç§è°ƒè¯•æ¨¡å¼
- âœ… **Makefile é›†æˆ** - ä¸æ„å»ºç³»ç»Ÿé›†æˆ

é€‰æ‹©æœ€é€‚åˆä½ çš„è°ƒè¯•æ–¹å¼ï¼Œå¼€å§‹é«˜æ•ˆçš„æµ‹è¯•è°ƒè¯•å§ï¼ 